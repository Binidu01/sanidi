name: ğŸ“¦ Release & Publish Sanidi

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  deployments: write

jobs:

  setup:
    name: ğŸ§± Setup Environment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org/"

      - name: Install dependencies
        run: npm ci

      - name: Read version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from package.json: $VERSION"

  build:
    name: ğŸ—ï¸ Build Package
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Pack tarball
        run: npm pack

  create-release:
    name: ğŸ·ï¸ Create GitHub Release
    needs: [setup, build]
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        id: release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ needs.setup.outputs.version }}
          release_name: Sanidi v${{ needs.setup.outputs.version }}
          body: |
            ğŸš€ **Sanidi v${{ needs.setup.outputs.version }} released**
            - Automated CI release
            - Published to npm
          draft: false
          prerelease: false

      - name: Upload tarball
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./sanidi-${{ needs.setup.outputs.version }}.tgz
          asset_name: sanidi-${{ needs.setup.outputs.version }}.tgz
          asset_content_type: application/gzip

  publish:
    name: ğŸ“¤ Publish to npm
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org/"

      - name: Install deps
        run: npm ci

      - name: Publish
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  verify:
    name: ğŸ” Verify Published Package
    needs: publish
    runs-on: ubuntu-latest

    steps:
      - name: Wait for NPM propagation
        run: sleep 10

      - name: Verify version availability
        run: |
          PUBLISHED=$(npm info sanidi version)
          EXPECTED=${{ needs.setup.outputs.version }}
          if [ "$PUBLISHED" != "$EXPECTED" ]; then
            echo "Published version mismatch! Expected $EXPECTED but got $PUBLISHED"
            exit 1
          fi
          echo "Verified: Version $PUBLISHED is live."

  create-deployment:
    name: ğŸš€ Register GitHub Deployment
    needs: [setup, build, create-release, publish, verify]
    runs-on: ubuntu-latest

    steps:
      - name: Create Deployment
        id: dep
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: "production",
              auto_merge: false,
              required_contexts: []
            });
            core.setOutput("deployment_id", result.data.id);

      - name: Mark Deployment Successful
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: "${{ steps.dep.outputs.deployment_id }}",
              state: "success",
              description: "Sanidi successfully published",
              environment_url: "https://www.npmjs.com/package/sanidi"
            });
