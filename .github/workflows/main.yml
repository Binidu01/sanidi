name: ğŸš€ Release & Publish to NPM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.3)'
        required: true

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ===== JOB 1: SETUP & VALIDATION =====
  setup:
    runs-on: ubuntu-latest
    name: ğŸ” Validate & Setup
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Use semantic versioning: 1.0.0"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version validated: $VERSION"

  # ===== JOB 2: BUILD & TEST =====
  build:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build & Test
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present || echo "âš ï¸ No lint script"

      - name: Run tests
        run: npm test || echo "âš ï¸ No test script"

      - name: Build package
        run: npm run build --if-present || echo "âš ï¸ No build script"

      - name: Create package archive
        run: |
          npm pack
          ls -lah sanidi-*.tgz
          echo "âœ… Package created successfully"

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-artifact
          path: sanidi-*.tgz
          retention-days: 30

  # ===== JOB 3: CREATE GITHUB RELEASE =====
  create-release:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Create GitHub Release
    needs: [setup, build]
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_url: ${{ steps.create_release.outputs.html_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "Extracting changelog for v$VERSION"
          
          if [ -f CHANGELOG.md ]; then
            awk "/^## \[${VERSION}\]/,/^## \[/ {print}" CHANGELOG.md | head -n -1 > release_notes.md
          fi
          
          if [ ! -s release_notes.md ]; then
            cat > release_notes.md << EOF
## v$VERSION Release

### ğŸ‰ What's New
- Enhanced performance
- Bug fixes and improvements
- Better reliability
- AI-powered features
- Multi-language support
- Enterprise-grade analytics

### ğŸ“¦ Installation
\`\`\`bash
npm install sanidi@$VERSION
\`\`\`

### ğŸ“š Documentation
See [README.md](https://github.com/Binidu01/sanidi#readme) for full documentation.

### ğŸ”— Links
- NPM Package
- GitHub Repository
- Issues
EOF
          fi
          
          cat release_notes.md

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.setup.outputs.version }}
          name: Sanidi v${{ needs.setup.outputs.version }}
          bodyFile: release_notes.md
          draft: false
          prerelease: false
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Print release info
        run: |
          echo "âœ… GitHub Release created!"
          echo "Release ID: ${{ steps.create_release.outputs.id }}"
          echo "Release URL: ${{ steps.create_release.outputs.html_url }}"

  # ===== JOB 4: PUBLISH TO NPM & GITHUB PACKAGES =====
  publish:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Publish to NPM & GitHub Packages
    needs: [setup, build, create-release]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Display npm config
        run: |
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"

      # ===== FIXED AUTH: NPM REGISTRY =====
      - name: ğŸ“ Configure npm authentication (NPM Registry)
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          npm config set //registry.npmjs.org/:_authToken=${NPM_TOKEN}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Publish to NPM
      - name: ğŸ“¦ Publish to NPM Registry
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: âœ… Verify NPM publication
        run: |
          sleep 10
          VERSION=${{ needs.setup.outputs.version }}
          npm view sanidi@$VERSION
          echo "âœ… Successfully published sanidi@$VERSION to NPM!"

      # ===== TEST NPM INSTALL =====
      - name: ğŸ§ª Test NPM installation
        run: |
          mkdir test-npm-install
          cd test-npm-install
          npm init -y
          npm install sanidi@${{ needs.setup.outputs.version }}
          cd ..

      # ===== FIXED AUTH: GITHUB PACKAGES =====
      - name: ğŸ“ Configure npm auth for GitHub Packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> ~/.npmrc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Publish to GitHub Packages
      - name: ğŸ™ Update package name for GitHub Packages
        run: npm pkg set name="@Binidu01/sanidi"

      - name: ğŸ™ Publish to GitHub Packages
        run: npm publish --registry https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§ª Test GitHub Packages installation
        run: |
          mkdir test-github-install
          cd test-github-install
          npm init -y
          npm install @Binidu01/sanidi@${{ needs.setup.outputs.version }} --registry https://npm.pkg.github.com/
          cd ..

      - name: ğŸ“ Revert package name
        run: npm pkg set name="sanidi"

      - name: ğŸ“Š Display publication summary
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "Published v$VERSION to both registries."

  # ===== JOB 5: FINAL VERIFICATION =====
  verify:
    runs-on: ubuntu-latest
    name: âœ… Final Verification
    needs: [setup, publish, create-release]
    if: success()
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ” Final NPM verification
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          npm view sanidi@$VERSION

      - name: ğŸ” Final GitHub Packages verification
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          npm view @Binidu01/sanidi@$VERSION --registry https://npm.pkg.github.com/ || echo "âš ï¸ Appearing soon..."

      - name: ğŸ‰ Success Summary
        run: echo "ğŸ‰ Release v${{ needs.setup.outputs.version }} successful!"

  # ===== JOB 6: FAILURE NOTIFICATION =====
  failure-notification:
    runs-on: ubuntu-latest
    name: âŒ Failure Alert
    if: failure()
    steps:
      - name: âŒ Print failure message
        run: echo "âŒ Release failed. Check logs."
