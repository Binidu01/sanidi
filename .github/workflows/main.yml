name: ðŸš€ Release & Publish to NPM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.3)'
        required: true

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ===== JOB 1: SETUP & VALIDATION =====
  setup:
    runs-on: ubuntu-latest
    name: ðŸ” Validate & Setup
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Use semantic versioning: 1.0.0"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version validated: $VERSION"

  # ===== JOB 2: BUILD & TEST =====
  build:
    runs-on: ubuntu-latest
    name: ðŸ—ï¸ Build & Test
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present || echo "âš ï¸ No lint script"

      - name: Run tests
        run: npm test || echo "âš ï¸ No test script"

      - name: Build package
        run: npm run build --if-present || echo "âš ï¸ No build script"

      - name: Create package archive
        run: |
          npm pack
          ls -lah sanidi-*.tgz
          echo "âœ… Package created successfully"

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-artifact
          path: sanidi-*.tgz
          retention-days: 30

  # ===== JOB 3: CREATE GITHUB RELEASE =====
  create-release:
    runs-on: ubuntu-latest
    name: ðŸ“¦ Create GitHub Release
    needs: [setup, build]
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_url: ${{ steps.create_release.outputs.html_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "Extracting changelog for v$VERSION"
          
          if [ -f CHANGELOG.md ]; then
            awk "/^## \[${VERSION}\]/,/^## \[/ {print}" CHANGELOG.md | head -n -1 > release_notes.md
          fi
          
          if [ ! -s release_notes.md ]; then
            cat > release_notes.md << EOF
          ## v$VERSION Release
          
          ### ðŸŽ‰ What's New
          - Enhanced performance
          - Bug fixes and improvements
          - Better reliability
          - AI-powered features
          - Multi-language support
          - Enterprise-grade analytics
          
          ### ðŸ“¦ Installation
          \`\`\`bash
          npm install sanidi@$VERSION
          \`\`\`
          
          ### ðŸ“š Documentation
          See [README.md](https://github.com/Binidu01/sanidi#readme) for full documentation.
          
          ### ðŸ”— Links
          - [NPM Package](https://www.npmjs.com/package/sanidi)
          - [GitHub Repository](https://github.com/Binidu01/sanidi)
          - [Issues](https://github.com/Binidu01/sanidi/issues)
          EOF
          fi
          
          cat release_notes.md

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ needs.setup.outputs.version }}
          name: ðŸŽ‰ Sanidi v${{ needs.setup.outputs.version }}
          bodyFile: release_notes.md
          draft: false
          prerelease: false
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Print release info
        run: |
          echo "âœ… GitHub Release created!"
          echo "Release ID: ${{ steps.create_release.outputs.id }}"
          echo "Release URL: ${{ steps.create_release.outputs.html_url }}"

  # ===== JOB 4: PUBLISH TO NPM & GITHUB PACKAGES =====
  publish:
    runs-on: ubuntu-latest
    name: ðŸ“¦ Publish to NPM & GitHub Packages
    needs: [setup, build, create-release]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Display npm config
        run: |
          echo "Node: $(node --version)"
          echo "NPM: $(npm --version)"

      # ===== PUBLISH TO NPM REGISTRY =====
      - name: ðŸ“¦ Publish to NPM Registry
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: âœ… Verify NPM publication
        run: |
          sleep 10
          VERSION=${{ needs.setup.outputs.version }}
          echo "ðŸ” Verifying NPM publication of sanidi@$VERSION"
          npm view sanidi@$VERSION
          echo "âœ… Successfully published sanidi@$VERSION to NPM!"

      - name: ðŸ§ª Test NPM installation
        run: |
          mkdir test-npm-install
          cd test-npm-install
          npm init -y
          npm install sanidi@${{ needs.setup.outputs.version }}
          echo "âœ… NPM installation test passed!"
          cd ..
          rm -rf test-npm-install

      # ===== PUBLISH TO GITHUB PACKAGES =====
      - name: ðŸ™ Update package name for GitHub Packages
        run: npm pkg set name="@Binidu01/sanidi"

      - name: ðŸ™ Publish to GitHub Packages
        run: npm publish --registry https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Verify GitHub Packages publication
        run: |
          sleep 10
          VERSION=${{ needs.setup.outputs.version }}
          echo "ðŸ” Verifying @Binidu01/sanidi@$VERSION on GitHub Packages"
          npm view @Binidu01/sanidi@$VERSION --registry https://npm.pkg.github.com/ || echo "âš ï¸ Package appearing..."
          echo "âœ… Published to GitHub Packages!"

      - name: ðŸ§ª Test GitHub Packages installation
        run: |
          mkdir test-github-install
          cd test-github-install
          npm init -y
          npm install @Binidu01/sanidi@${{ needs.setup.outputs.version }} --registry https://npm.pkg.github.com/
          echo "âœ… GitHub Packages installation test passed!"
          cd ..
          rm -rf test-github-install

      - name: ðŸ“ Revert package name
        run: npm pkg set name="sanidi"

      - name: ðŸ“Š Display publication summary
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          cat << EOF
          
          ðŸŽ‰ Publication Summary
          ======================
          
          Version: v$VERSION
          
          âœ… NPM Registry
             URL: https://www.npmjs.com/package/sanidi@$VERSION
             Install: npm install sanidi@$VERSION
          
          âœ… GitHub Packages
             URL: https://github.com/Binidu01/sanidi/packages
             Install: npm install @Binidu01/sanidi@$VERSION --registry https://npm.pkg.github.com/
          
          EOF

  # ===== JOB 5: FINAL VERIFICATION & SUCCESS =====
  verify:
    runs-on: ubuntu-latest
    name: âœ… Final Verification
    needs: [setup, publish, create-release]
    if: success()
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ” Final NPM verification
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "Final check for sanidi@$VERSION on NPM"
          npm view sanidi@$VERSION
          echo "âœ… NPM publication verified!"

      - name: ðŸ” Final GitHub Packages verification
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          echo "Final check for @Binidu01/sanidi@$VERSION on GitHub"
          npm view @Binidu01/sanidi@$VERSION --registry https://npm.pkg.github.com/ || echo "âš ï¸ Appearing soon..."
          echo "âœ… GitHub Packages publication verified!"

      - name: ðŸŽ‰ Success Summary
        run: |
          cat << 'EOF'
          
          ðŸŽ‰ ðŸŽ‰ ðŸŽ‰ RELEASE SUCCESSFUL! ðŸŽ‰ ðŸŽ‰ ðŸŽ‰
          
          âœ… Sanidi v${{ needs.setup.outputs.version }} Released!
          
          ðŸ“¦ Published Packages:
          
          1ï¸âƒ£ NPM Registry
             Package: sanidi
             URL: https://www.npmjs.com/package/sanidi@${{ needs.setup.outputs.version }}
             Install: npm install sanidi@${{ needs.setup.outputs.version }}
          
          2ï¸âƒ£ GitHub Packages
             Package: @Binidu01/sanidi
             URL: https://github.com/Binidu01/sanidi/packages
             Install: npm install @Binidu01/sanidi@${{ needs.setup.outputs.version }} --registry https://npm.pkg.github.com/
          
          3ï¸âƒ£ GitHub Release
             URL: https://github.com/Binidu01/sanidi/releases/tag/v${{ needs.setup.outputs.version }}
          
          ðŸ”— Quick Links:
          - Main Package: https://www.npmjs.com/package/sanidi
          - Repository: https://github.com/Binidu01/sanidi
          - Documentation: https://github.com/Binidu01/sanidi#readme
          
          EOF

      - name: ðŸ“‹ Create GitHub Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸŽ‰ Release Complete: v${{ needs.setup.outputs.version }}
          
          ## Status: âœ… SUCCESS
          
          ### ðŸ“¦ All Packages Published
          
          - âœ… [NPM Registry](https://www.npmjs.com/package/sanidi@${{ needs.setup.outputs.version }})
          - âœ… [GitHub Packages](https://github.com/Binidu01/sanidi/packages)
          - âœ… [GitHub Release](https://github.com/Binidu01/sanidi/releases/tag/v${{ needs.setup.outputs.version }})
          
          ### ðŸ“¥ Installation Commands
          
          **NPM Registry:**
          \`npm install sanidi@${{ needs.setup.outputs.version }}\`
          
          **GitHub Packages:**
          \`npm install @Binidu01/sanidi@${{ needs.setup.outputs.version }} --registry https://npm.pkg.github.com/\`
          
          ### âœ… Jobs Completed
          - Setup & Validation âœ…
          - Build & Test âœ…
          - Create GitHub Release âœ…
          - Publish to NPM Registry âœ…
          - Publish to GitHub Packages âœ…
          - Final Verification âœ…
          
          **All systems go! ðŸš€**
          EOF

  # ===== JOB 6: FAILURE NOTIFICATION =====
  failure-notification:
    runs-on: ubuntu-latest
    name: âŒ Failure Alert
    if: failure()
    steps:
      - name: âŒ Print failure message
        run: |
          cat << 'EOF'
          
          âŒ âŒ âŒ RELEASE FAILED âŒ âŒ âŒ
          
          The release workflow encountered an error.
          
          Troubleshooting:
          
          1. Check version format (must be: 1.0.3)
          2. Verify NPM_TOKEN secret exists
          3. Verify GITHUB_TOKEN is available
          4. Check build/test logs above
          5. Ensure package.json is valid JSON
          
          Common Issues:
          - Invalid version format
          - NPM_TOKEN not configured
          - Package already published
          - Tests failing
          - Build errors
          
          Resources:
          - GitHub Issues: https://github.com/Binidu01/sanidi/issues
          - NPM Docs: https://docs.npmjs.com/
          - Workflow Logs: Check Actions tab
          
          EOF
          exit 1
